# File: templates/gitlab.rb.j2 - GitLab configuration template

external_url '{{ gitlab_tls_enabled | ternary("https", "http") }}://{{ ansible_fqdn }}'

# Git data directory
git_data_dirs({
  "default" => {
    "path" => "{{ gitlab_data_path }}"
  }
})

# Enable TLS if configured
{% if gitlab_tls_enabled %}
nginx['ssl_certificate'] = "{{ gitlab_config_path }}/ssl/{{ gitlab_tls_cert_file }}"
nginx['ssl_certificate_key'] = "{{ gitlab_config_path }}/ssl/{{ gitlab_tls_key_file }}"
{% endif %}

# Logging
logging['level'] = "info"

# Enable Prometheus metrics
prometheus_monitoring['enable'] = true
node_exporter['enable'] = true
redis_exporter['enable'] = true
postgres_exporter['enable'] = true
gitlab_exporter['enable'] = true

# Prometheus listen address
prometheus['listen_address'] = "0.0.0.0:9090"

# Grafana integration (optional)
grafana['enable'] = {{ gitlab_grafana_enabled | default(false) | bool }}
grafana['admin_password'] = "{{ gitlab_grafana_admin_password }}"
